!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../ruby/ruby")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../ruby/ruby"],e):e(CodeMirror)}(function(e){"use strict";e.defineMode("slim",function(t){function y(e,t,r){var i=function(i,n){return n.tokenize=t,i.pos<e?(i.pos=e,r):n.tokenize(i,n)};return function(e,r){return r.tokenize=i,t(e,r)}}function g(e,t,r,i,n){var a=e.current(),o=a.search(r);return o>-1&&(t.tokenize=y(e.pos,t.tokenize,n),e.backUp(a.length-o-i)),n}function v(e,t){e.stack={parent:e.stack,style:"continuation",indented:t,tokenize:e.line},e.line=e.tokenize}function b(e){e.line==e.tokenize&&(e.line=e.stack.tokenize,e.stack=e.stack.parent)}function x(e,t){return function(r,i){if(b(i),r.match(/^\\$/))return v(i,e),"lineContinuation";var n=t(r,i);return r.eol()&&r.current().match(/(?:^|[^\\])(?:\\\\)*\\$/)&&r.backUp(1),n}}function w(e,t){return function(r,i){b(i);var n=t(r,i);return r.eol()&&r.current().match(/,$/)&&v(i,e),n}}function k(e,t){return function(r,i){var n=r.peek();return n==e&&1==i.rubyState.tokenize.length?(r.next(),i.tokenize=t,"closeAttributeTag"):j(r,i)}}function _(e){var t,r=function(r,i){if(1==i.rubyState.tokenize.length&&!i.rubyState.context.prev){if(r.backUp(1),r.eatSpace())return i.rubyState=t,i.tokenize=e,e(r,i);r.next()}return j(r,i)};return function(e,n){return t=n.rubyState,n.rubyState=i.startState(),n.tokenize=r,j(e,n)}}function j(e,t){return i.token(e,t.rubyState)}function S(e,t){return e.match(/^\\$/)?"lineContinuation":T(e,t)}function T(e,t){return e.match(/^#\{/)?(t.tokenize=k("}",t.tokenize),null):g(e,t,/[^\\]#\{/,1,r.token(e,t.htmlState))}function Q(e){return function(t,r){var i=S(t,r);return t.eol()&&(r.tokenize=e),i}}function C(e,t,r){return t.stack={parent:t.stack,style:"html",indented:e.column()+r,tokenize:t.line},t.line=t.tokenize=T,null}function E(e,t){return e.skipToEnd(),t.stack.style}function N(e,t){return t.stack={parent:t.stack,style:"comment",indented:t.indented+1,tokenize:t.line},t.line=E,E(e,t)}function $(e,t){return e.eat(t.stack.endQuote)?(t.line=t.stack.line,t.tokenize=t.stack.tokenize,t.stack=t.stack.parent,null):e.match(p)?(t.tokenize=A,"slimAttribute"):(e.next(),null)}function A(e,t){return e.match(/^==?/)?(t.tokenize=M,null):$(e,t)}function M(e,t){var r=e.peek();return'"'==r||"'"==r?(t.tokenize=Y(r,"string",!0,!1,$),e.next(),t.tokenize(e,t)):"["==r?_($)(e,t):e.match(/^(true|false|nil)\b/)?(t.tokenize=$,"keyword"):_($)(e,t)}function I(e,t,r){return e.stack={parent:e.stack,style:"wrapper",indented:e.indented+1,tokenize:r,line:e.line,endQuote:t},e.line=e.tokenize=$,null}function O(t,r){if(t.match(/^#\{/))return r.tokenize=k("}",r.tokenize),null;var i=new e.StringStream(t.string.slice(r.stack.indented),t.tabSize);i.pos=t.pos-r.stack.indented,i.start=t.start-r.stack.indented,i.lastColumnPos=t.lastColumnPos-r.stack.indented,i.lastColumnValue=t.lastColumnValue-r.stack.indented;var n=r.subMode.token(i,r.subState);return t.pos=i.pos+r.stack.indented,n}function L(e,t){return t.stack.indented=e.column(),t.line=t.tokenize=O,t.tokenize(e,t)}function D(r){var i=a[r],n=e.mimeModes[i];if(n)return e.getMode(t,n);var o=e.modes[i];return o?o(t,{name:i}):e.getMode(t,"null")}function R(e){return n.hasOwnProperty(e)?n[e]:n[e]=D(e)}function q(e,t){var r=R(e),i=r.startState&&r.startState();return t.subMode=r,t.subState=i,t.stack={parent:t.stack,style:"sub",indented:t.indented+1,tokenize:t.line},t.line=t.tokenize=L,"slimSubmode"}function z(e,t){return e.skipToEnd(),"slimDoctype"}function P(e,t){var r=e.peek();if("<"==r)return(t.tokenize=Q(t.tokenize))(e,t);if(e.match(/^[|']/))return C(e,t,1);if(e.match(/^\/(!|\[\w+])?/))return N(e,t);if(e.match(/^(-|==?[<>]?)/))return t.tokenize=x(e.column(),w(e.column(),j)),"slimSwitch";if(e.match(/^doctype\b/))return t.tokenize=z,"keyword";var i=e.match(o);return i?q(i[1],t):H(e,t)}function F(e,t){return t.startOfLine?P(e,t):H(e,t)}function H(e,t){return e.eat("*")?(t.tokenize=_(B),null):e.match(f)?(t.tokenize=B,"slimTag"):U(e,t)}function B(e,t){return e.match(/^(<>?|><?)/)?(t.tokenize=U,null):U(e,t)}function U(e,t){return e.match(m)?(t.tokenize=U,"slimId"):e.match(h)?(t.tokenize=U,"slimClass"):W(e,t)}function W(e,t){return e.match(/^([\[\{\(])/)?I(t,l[RegExp.$1],W):e.match(d)?(t.tokenize=V,"slimAttribute"):"*"==e.peek()?(e.next(),t.tokenize=_(K),null):K(e,t)}function V(e,t){return e.match(/^==?/)?(t.tokenize=G,null):W(e,t)}function G(e,t){var r=e.peek();return'"'==r||"'"==r?(t.tokenize=Y(r,"string",!0,!1,W),e.next(),t.tokenize(e,t)):"["==r?_(W)(e,t):":"==r?_(X)(e,t):e.match(/^(true|false|nil)\b/)?(t.tokenize=W,"keyword"):_(W)(e,t)}function X(e,t){return e.backUp(1),e.match(/^[^\s],(?=:)/)?(t.tokenize=_(X),null):(e.next(),W(e,t))}function Y(e,t,r,i,n){return function(a,o){b(o);var s=0==a.current().length;if(a.match(/^\\$/,s))return s?(v(o,o.indented),"lineContinuation"):t;if(a.match(/^#\{/,s))return s?(o.tokenize=k("}",o.tokenize),null):t;for(var u,l=!1;null!=(u=a.next());){if(u==e&&(i||!l)){o.tokenize=n;break}if(r&&"#"==u&&!l&&a.eat("{")){a.backUp(2);break}l=!l&&"\\"==u}return a.eol()&&l&&a.backUp(1),t}}function K(e,t){return e.match(/^==?/)?(t.tokenize=j,"slimSwitch"):e.match(/^\/$/)?(t.tokenize=F,null):e.match(/^:/)?(t.tokenize=H,"slimSwitch"):(C(e,t,0),t.tokenize(e,t))}var r=e.getMode(t,{name:"htmlmixed"}),i=e.getMode(t,"ruby"),n={html:r,ruby:i},a={ruby:"ruby",javascript:"javascript",css:"text/css",sass:"text/x-sass",scss:"text/x-scss",less:"text/x-less",styl:"text/x-styl",coffee:"coffeescript",asciidoc:"text/x-asciidoc",markdown:"text/x-markdown",textile:"text/x-textile",creole:"text/x-creole",wiki:"text/x-wiki",mediawiki:"text/x-mediawiki",rdoc:"text/x-rdoc",builder:"text/x-builder",nokogiri:"text/x-nokogiri",erb:"application/x-erb"},o=function(e){var t=[];for(var r in e)t.push(r);return new RegExp("^("+t.join("|")+"):")}(a),s={commentLine:"comment",slimSwitch:"operator special",slimTag:"tag",slimId:"attribute def",slimClass:"attribute qualifier",slimAttribute:"attribute",slimSubmode:"keyword special",closeAttributeTag:null,slimDoctype:null,lineContinuation:null},l={"{":"}","[":"]","(":")"},u="_a-zA-ZÀ-ÖØ-öø-˿Ͱ-ͽͿ-῿‌-‍⁰-↏Ⰰ-⿯、-퟿豈-﷏ﷰ-�",c=u+"\\-0-9·̀-ͯ‿-⁀",f=new RegExp("^[:"+u+"](?::["+c+"]|["+c+"]*)"),d=new RegExp("^[:"+u+"][:\\."+c+"]*(?=\\s*=)"),p=new RegExp("^[:"+u+"][:\\."+c+"]*"),h=/^\.-?[_a-zA-Z]+[\w\-]*/,m=/^#[_a-zA-Z]+[\w\-]*/,Z={startState:function(){var e=r.startState(),t=i.startState();return{htmlState:e,rubyState:t,stack:null,last:null,tokenize:F,line:F,indented:0}},copyState:function(t){return{htmlState:e.copyState(r,t.htmlState),rubyState:e.copyState(i,t.rubyState),subMode:t.subMode,subState:t.subMode&&e.copyState(t.subMode,t.subState),stack:t.stack,last:t.last,tokenize:t.tokenize,line:t.line}},token:function(e,t){if(e.sol())for(t.indented=e.indentation(),t.startOfLine=!0,t.tokenize=t.line;t.stack&&t.stack.indented>t.indented&&"slimSubmode"!=t.last;)t.line=t.tokenize=t.stack.tokenize,t.stack=t.stack.parent,t.subMode=null,t.subState=null;if(e.eatSpace())return null;var r=t.tokenize(e,t);return t.startOfLine=!1,r&&(t.last=r),s.hasOwnProperty(r)?s[r]:r},blankLine:function(e){return e.subMode&&e.subMode.blankLine?e.subMode.blankLine(e.subState):void 0},innerMode:function(e){return e.subMode?{state:e.subState,mode:e.subMode}:{state:e,mode:Z}}};return Z},"htmlmixed","ruby"),e.defineMIME("text/x-slim","slim"),e.defineMIME("application/x-slim","slim")});
