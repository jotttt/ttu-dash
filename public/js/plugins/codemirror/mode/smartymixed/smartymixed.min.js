!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../smarty/smarty")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../smarty/smarty"],e):e(CodeMirror)}(function(e){"use strict";e.defineMode("smartymixed",function(t){function a(e){return e.replace(/[^\s\w]/g,"\\$&")}var r=e.getMode(t,"htmlmixed"),i=e.getMode(t,"smarty"),n={rightDelimiter:"}",leftDelimiter:"{"};t.hasOwnProperty("leftDelimiter")&&(n.leftDelimiter=t.leftDelimiter),t.hasOwnProperty("rightDelimiter")&&(n.rightDelimiter=t.rightDelimiter);var o=a(n.leftDelimiter),s=a(n.rightDelimiter),l={smartyComment:new RegExp("^"+s+"\\*"),literalOpen:new RegExp(o+"literal"+s),literalClose:new RegExp(o+"/literal"+s),hasLeftDelimeter:new RegExp(".*"+o),htmlHasLeftDelimeter:new RegExp("[^<>]*"+o)},u={chain:function(e,t,r){return t.tokenize=r,r(e,t)},cleanChain:function(e,t,r){return t.tokenize=null,t.localState=null,t.localMode=null,"string"==typeof r?r?r:null:r(e,t)},maybeBackup:function(e,t,r){var a,i=e.current(),n=i.search(t);return n>-1?e.backUp(i.length-n):(a=i.match(/<\/?$/))&&(e.backUp(i.length),e.match(t,!1)||e.match(i[0])),r}},c={html:function(e,t){var a=t.htmlMixedState.htmlState.context&&t.htmlMixedState.htmlState.context.tagName?t.htmlMixedState.htmlState.context.tagName:null;return!t.inLiteral&&e.match(l.htmlHasLeftDelimeter,!1)&&null===a?(t.tokenize=c.smarty,t.localMode=i,t.localState=i.startState(r.indent(t.htmlMixedState,"")),u.maybeBackup(e,n.leftDelimiter,i.token(e,t.localState))):!t.inLiteral&&e.match(n.leftDelimiter,!1)?(t.tokenize=c.smarty,t.localMode=i,t.localState=i.startState(r.indent(t.htmlMixedState,"")),u.maybeBackup(e,n.leftDelimiter,i.token(e,t.localState))):r.token(e,t.htmlMixedState)},smarty:function(e,t){if(e.match(n.leftDelimiter,!1)){if(e.match(l.smartyComment,!1))return u.chain(e,t,c.inBlock("comment","*"+n.rightDelimiter))}else if(e.match(n.rightDelimiter,!1))return e.eat(n.rightDelimiter),t.tokenize=c.html,t.localMode=r,t.localState=t.htmlMixedState,"tag";return u.maybeBackup(e,n.rightDelimiter,i.token(e,t.localState))},inBlock:function(e,t){return function(r,i){for(;!r.eol();){if(r.match(t)){u.cleanChain(r,i,"");break}r.next()}return e}}};return{startState:function(){var e=r.startState();return{token:c.html,localMode:null,localState:null,htmlMixedState:e,tokenize:null,inLiteral:!1}},copyState:function(t){var n=null,a=t.tokenize||t.token;return t.localState&&(n=e.copyState(a!=c.html?i:r,t.localState)),{token:t.token,tokenize:t.tokenize,localMode:t.localMode,localState:n,htmlMixedState:e.copyState(r,t.htmlMixedState),inLiteral:t.inLiteral}},token:function(e,t){if(e.match(n.leftDelimiter,!1)){if(!t.inLiteral&&e.match(l.literalOpen,!0))return t.inLiteral=!0,"keyword";if(t.inLiteral&&e.match(l.literalClose,!0))return t.inLiteral=!1,"keyword"}t.inLiteral&&t.localState!=t.htmlMixedState&&(t.tokenize=c.html,t.localMode=r,t.localState=t.htmlMixedState);var i=(t.tokenize||t.token)(e,t);return i},indent:function(t,n){return t.localMode==i||t.inLiteral&&!t.localMode||l.hasLeftDelimeter.test(n)?e.Pass:r.indent(t.htmlMixedState,n)},innerMode:function(e){return{state:e.localState||e.htmlMixedState,mode:e.localMode||r}}}},"htmlmixed","smarty"),e.defineMIME("text/x-smarty","smartymixed")});
