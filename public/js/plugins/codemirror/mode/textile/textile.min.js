!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function r(e,r,i){this.regExpFactory=e,this.state=r,this.stream=i,this.styles=t,this.state.specialChar=null}function i(){this.cache={},this.single={bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},this.attributes={align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/}}var t={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"};r.prototype.eat=function(e){return this.stream.match(this.regExpFactory.pattern(e),!0)},r.prototype.check=function(e){return this.stream.match(this.regExpFactory.pattern(e),!1)},r.prototype.setModeForNextToken=function(e){return this.state.mode=e},r.prototype.execMode=function(e){return this.setModeForNextToken(e).call(this)},r.prototype.startNewLine=function(){this.setModeForNextToken(n.newLayout),this.state.tableHeading=!1,"definitionList"===this.state.layoutType&&this.state.spanningLayout&&this.check("definitionListEnd")&&(this.state.spanningLayout=!1)},r.prototype.nextToken=function(){return this.state.mode.call(this)},r.prototype.styleFor=function(e){if(this.styles.hasOwnProperty(e))return this.styles[e];throw"unknown token"},r.prototype.handlePhraseModifier=function(e){if("_"===e)return this.stream.eat("_")?this.togglePhraseModifier("italic",/^.*__/):this.togglePhraseModifier("em",/^.*_/);if("*"===e)return this.stream.eat("*")?this.togglePhraseModifier("bold",/^.*\*\*/):this.togglePhraseModifier("strong",/^.*\*/);if("["===e)return this.stream.match(/\d+\]/)&&(this.state.footCite=!0),this.tokenStyles();if("("===e)return this.stream.match("r)")?this.state.specialChar="r":this.stream.match("tm)")?this.state.specialChar="tm":this.stream.match("c)")&&(this.state.specialChar="c"),this.tokenStyles();if("<"===e&&this.stream.match(/(\w+)[^>]+>[^<]+<\/\1>/))return this.tokenStylesWith(this.styleFor("html"));if("?"===e&&this.stream.eat("?"))return this.togglePhraseModifier("cite",/^.*\?\?/);if("="===e&&this.stream.eat("="))return this.togglePhraseModifier("notextile",/^.*==/);if("-"===e)return this.togglePhraseModifier("deletion",/^.*-/);if("+"===e)return this.togglePhraseModifier("addition",/^.*\+/);if("~"===e)return this.togglePhraseModifier("sub",/^.*~/);if("^"===e)return this.togglePhraseModifier("sup",/^.*\^/);if("%"===e)return this.togglePhraseModifier("span",/^.*%/);if("@"===e)return this.togglePhraseModifier("code",/^.*@/);if("!"===e){var t=this.togglePhraseModifier("image",/^.*(?:\([^\)]+\))?!/);return this.stream.match(/^:\S+/),t}return this.tokenStyles()},r.prototype.togglePhraseModifier=function(e,t){if(this.state[e]){var r=this.tokenStyles();return this.state[e]=!1,r}return this.stream.match(t,!1)&&(this.state[e]=!0,this.setModeForNextToken(n.attributes)),this.tokenStyles()},r.prototype.tokenStyles=function(){var e=this.textileDisabled(),t=[];return e?e:(this.state.layoutType&&t.push(this.styleFor(this.state.layoutType)),t=t.concat(this.activeStyles("addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","specialChar","strong","sub","sup","table","tableHeading")),"header"===this.state.layoutType&&t.push(this.styleFor("header")+"-"+this.state.header),t.length?t.join(" "):null)},r.prototype.textileDisabled=function(){var e=this.state.layoutType;switch(e){case"notextile":case"code":case"pre":return this.styleFor(e);default:return this.state.notextile?this.styleFor("notextile")+(e?" "+this.styleFor(e):""):null}},r.prototype.tokenStylesWith=function(e){var r,t=this.textileDisabled();return t?t:(r=this.tokenStyles(),e?r?r+" "+e:e:r)},r.prototype.activeStyles=function(){var t,e=[];for(t=0;t<arguments.length;++t)this.state[arguments[t]]&&e.push(this.styleFor(arguments[t]));return e},r.prototype.blankLine=function(){var r,e=this.state.spanningLayout,t=this.state.layoutType;for(r in this.state)this.state.hasOwnProperty(r)&&delete this.state[r];this.setModeForNextToken(n.newLayout),e&&(this.state.layoutType=t,this.state.spanningLayout=!0)},i.prototype.pattern=function(e){return this.cache[e]||this.createRe(e)},i.prototype.createRe=function(e){switch(e){case"drawTable":return this.makeRe("^",this.single.drawTable,"$");case"html":return this.makeRe("^",this.single.html,"(?:",this.single.html,")*","$");case"linkDefinition":return this.makeRe("^",this.single.linkDefinition,"$");case"listLayout":return this.makeRe("^",this.single.list,this.pattern("allAttributes"),"*\\s+");case"tableCellAttributes":return this.makeRe("^",this.choiceRe(this.single.tableCellAttributes,this.pattern("allAttributes")),"+\\.");case"type":return this.makeRe("^",this.pattern("allTypes"));case"typeLayout":return this.makeRe("^",this.pattern("allTypes"),this.pattern("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return this.makeRe("^",this.pattern("allAttributes"),"+");case"allTypes":return this.choiceRe(this.single.div,this.single.foot,this.single.header,this.single.bc,this.single.bq,this.single.notextile,this.single.pre,this.single.table,this.single.para);case"allAttributes":return this.choiceRe(this.attributes.selector,this.attributes.css,this.attributes.lang,this.attributes.align,this.attributes.pad);default:return this.makeRe("^",this.single[e])}},i.prototype.makeRe=function(){var t,r,e="";for(t=0;t<arguments.length;++t)r=arguments[t],e+="string"==typeof r?r:r.source;return new RegExp(e)},i.prototype.choiceRe=function(){var t,e=[arguments[0]];for(t=1;t<arguments.length;++t)e[2*t-1]="|",e[2*t]=arguments[t];return e.unshift("(?:"),e.push(")"),this.makeRe.apply(this,e)};var n={newLayout:function(){if(this.check("typeLayout"))return this.state.spanningLayout=!1,this.execMode(n.blockType);if(!this.textileDisabled()){if(this.check("listLayout"))return this.execMode(n.list);if(this.check("drawTable"))return this.execMode(n.table);if(this.check("linkDefinition"))return this.execMode(n.linkDefinition);if(this.check("definitionList"))return this.execMode(n.definitionList);if(this.check("html"))return this.execMode(n.html)}return this.execMode(n.text)},blockType:function(){var e,t;return this.state.layoutType=null,(e=this.eat("type"))?(t=e[0],(e=t.match(this.regExpFactory.pattern("header")))?(this.state.layoutType="header",this.state.header=parseInt(e[0][1])):t.match(this.regExpFactory.pattern("bq"))?this.state.layoutType="quote":t.match(this.regExpFactory.pattern("bc"))?this.state.layoutType="code":t.match(this.regExpFactory.pattern("foot"))?this.state.layoutType="footnote":t.match(this.regExpFactory.pattern("notextile"))?this.state.layoutType="notextile":t.match(this.regExpFactory.pattern("pre"))?this.state.layoutType="pre":t.match(this.regExpFactory.pattern("div"))?this.state.layoutType="div":t.match(this.regExpFactory.pattern("table"))&&(this.state.layoutType="table"),this.setModeForNextToken(n.attributes),this.tokenStyles()):this.execMode(n.text)},text:function(){if(this.eat("text"))return this.tokenStyles();var e=this.stream.next();return'"'===e?this.execMode(n.link):this.handlePhraseModifier(e)},attributes:function(){return this.setModeForNextToken(n.layoutLength),this.eat("attributes")?this.tokenStylesWith(this.styleFor("attributes")):this.tokenStyles()},layoutLength:function(){return this.stream.eat(".")&&this.stream.eat(".")&&(this.state.spanningLayout=!0),this.setModeForNextToken(n.text),this.tokenStyles()},list:function(){var t,e=this.eat("list");return this.state.listDepth=e[0].length,t=(this.state.listDepth-1)%3,t?1===t?this.state.layoutType="list2":this.state.layoutType="list3":this.state.layoutType="list1",this.setModeForNextToken(n.attributes),this.tokenStyles()},link:function(){return this.setModeForNextToken(n.text),this.eat("link")?(this.stream.match(/\S+/),this.tokenStylesWith(this.styleFor("link"))):this.tokenStyles()},linkDefinition:function(){return this.stream.skipToEnd(),this.tokenStylesWith(this.styleFor("linkDefinition"))},definitionList:function(){return this.eat("definitionList"),this.state.layoutType="definitionList",this.stream.match(/\s*$/)?this.state.spanningLayout=!0:this.setModeForNextToken(n.attributes),this.tokenStyles()},html:function(){return this.stream.skipToEnd(),this.tokenStylesWith(this.styleFor("html"))},table:function(){return this.state.layoutType="table",this.execMode(n.tableCell)},tableCell:function(){return this.eat("tableHeading")?this.state.tableHeading=!0:this.stream.eat("|"),this.setModeForNextToken(n.tableCellAttributes),this.tokenStyles()},tableCellAttributes:function(){return this.setModeForNextToken(n.tableText),this.eat("tableCellAttributes")?this.tokenStylesWith(this.styleFor("attributes")):this.tokenStyles()},tableText:function(){return this.eat("tableText")?this.tokenStyles():"|"===this.stream.peek()?(this.setModeForNextToken(n.tableCell),this.tokenStyles()):this.handlePhraseModifier(this.stream.next())}};e.defineMode("textile",function(){var e=new i;return{startState:function(){return{mode:n.newLayout}},token:function(t,i){var n=new r(e,i,t);return t.sol()&&n.startNewLine(),n.nextToken()},blankLine:function(t){new r(e,t).blankLine()}}}),e.defineMIME("text/x-textile","textile")});
